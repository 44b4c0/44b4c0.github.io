---
title: "XChat development рЃюрЃљрЃгрЃўрЃџрЃў #2"
date: 2024-09-16 14:06:00 +0400
categories: [Programming]
tags: [Coding]
---

## рЃгрЃарЃћрЃЊрЃћрЃЉрЃўрЃА рЃАрЃўрЃюрЃЦрЃарЃЮрЃюрЃўрЃќрЃљрЃфрЃўрЃљ

рЃърЃарЃЮрЃЉрЃџрЃћрЃЏрЃљ рЃўрЃЏрЃљрЃерЃў рЃЏрЃЊрЃњрЃЮрЃЏрЃљрЃарЃћрЃЮрЃЉрЃА, рЃарЃЮрЃЏ рЃЌрЃўрЃЌрЃЮрЃћрЃБрЃџрЃЏрЃљ рЃгрЃарЃћрЃЊрЃЏрЃљ рЃБрЃюрЃЊрЃљ рЃерЃћрЃФрЃџрЃЮрЃА `client_vector`-рЃЌрЃљрЃю рЃЏрЃБрЃерЃљрЃЮрЃЉрЃљ, рЃарЃљрЃЏрЃљрЃф рЃърЃарЃЮрЃЉрЃџрЃћрЃЏрЃћрЃЉрЃў рЃерЃћрЃўрЃФрЃџрЃћрЃЉрЃљ рЃњрЃљрЃЏрЃЮрЃўрЃгрЃЋрЃўрЃЮрЃА. рЃљрЃЏрЃўрЃА рЃњрЃљрЃЏрЃЮ, рЃЏрЃћ рЃЏрЃГрЃўрЃарЃЊрЃћрЃЉрЃљ рЃўрЃАрЃћрЃЌрЃў рЃарЃљрЃЏрЃўрЃА рЃњрЃљрЃЎрЃћрЃЌрЃћрЃЉрЃљ, рЃарЃљрЃф рЃгрЃарЃћрЃЊрЃћрЃЉрЃА рЃАрЃўрЃюрЃЦрЃарЃЮрЃюрЃБрЃџрЃљрЃЊ рЃљрЃЏрЃБрЃерЃљрЃЋрЃћрЃЉрЃА `client_vector`-рЃЌрЃљрЃю рЃЏрЃўрЃЏрЃљрЃарЃЌрЃћрЃЉрЃљрЃерЃў.

рЃљрЃЏрЃљрЃерЃў рЃерЃћрЃЏрЃўрЃФрЃџрЃўрЃљ Mutex рЃЊрЃљрЃЋрЃўрЃ«рЃЏрЃљрЃарЃЮ. рЃќрЃЮрЃњрЃљрЃЊрЃљрЃЊ, `Mutex` рЃюрЃўрЃерЃюрЃљрЃЋрЃА `Mutual Exclusion`-рЃА рЃЊрЃљ `C++` рЃћрЃюрЃљрЃерЃў рЃгрЃарЃћрЃЊрЃћрЃЉрЃўрЃА рЃарЃћрЃАрЃБрЃарЃАрЃћрЃЉрЃўрЃА рЃњрЃљрЃАрЃљрЃЎрЃЮрЃюрЃбрЃарЃЮрЃџрЃћрЃЉрЃџрЃљрЃЊ рЃњрЃљрЃЏрЃЮрЃўрЃДрЃћрЃюрЃћрЃЉрЃљ(рЃФрЃљрЃџрЃўрЃљрЃю рЃърЃарЃўрЃЏрЃўрЃбрЃўрЃБрЃџрЃў рЃљрЃ«рЃАрЃюрЃљрЃљ). рЃЊрЃљрЃљрЃ«рЃџрЃЮрЃћрЃЉрЃўрЃЌ рЃљрЃАрЃћрЃЌрЃў  рЃарЃљрЃЏ рЃ«рЃЊрЃћрЃЉрЃљ, рЃарЃЮрЃЊрЃћрЃАрЃљрЃф рЃћрЃарЃЌрЃў рЃЮрЃЉрЃўрЃћрЃЦрЃбрЃќрЃћ рЃарЃљрЃЏрЃЊрЃћрЃюрЃўрЃЏрЃћ рЃгрЃарЃћрЃЊрЃА рЃБрЃюрЃЊрЃљ рЃЏрЃБрЃерЃљрЃЮрЃЉрЃљ:
```
   РћїРћђРћђРћђРћђРћђРћђРћђРћђРћђРћљ                                         
   РћѓThread #2Рћѓ                                         
   РћћРћђРћђРћђРћђРћђРћђРћђРћђРћђРћў                                         
        Рћѓ                                              
        Рћѓ                                              
        Рћѓ                                              
        Рћѓ                                              
        Рћѓ                                              
        Рћѓ                                              
        Рћѓ                                              
        Рћѓ                                              
        Рћѓ                                              
        x                                              
РћїРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћљ               РћїРћђРћђРћђРћђРћђРћђРћђРћђРћђРћљ            
РћѓProtector MutexРћѓРЌёРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћцThread #1Рћѓ            
РћћРћђРћђРћђРћђРћђРћђРћђРћгРћђРћђРћђРћђРћђРћђРћђРћў               РћћРћђРћђРћђРћђРћђРћђРћђРћђРћђРћў            
        Рћѓ                                              
        Рћѓ                                              
        Рћѓ                                              
        Рќ╝                                              
 РћїРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћљ             РћїРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћљ
 Рћѓclient_vectorРћюРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРќ║Рћѓ{Item1, Item2, Item3...}Рћѓ
 РћћРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћў             РћћРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћў
```

рЃљрЃЏ рЃерЃћрЃЏрЃЌрЃ«рЃЋрЃћрЃЋрЃљрЃерЃў,  `Thread #1` рЃЏрЃБрЃерЃљрЃЮрЃЉрЃА `client_vector`-рЃЌрЃљрЃю, рЃарЃЮрЃЏрЃћрЃџрЃўрЃф `Protector Mutex`-рЃА рЃ░рЃДрЃљрЃЋрЃА рЃЕрЃљрЃЎрЃћрЃбрЃўрЃџрЃў. рЃарЃЮрЃЊрЃћрЃАрЃљрЃф `Thread #1` рЃЋрЃћрЃЦрЃбрЃЮрЃарЃЌрЃљрЃю рЃЏрЃБрЃерЃљрЃЮрЃЉрЃљрЃА рЃЏрЃЮрЃарЃЕрЃћрЃЉрЃљ, `Protector Mutex` рЃњрЃљрЃўрЃ«рЃАрЃюрЃћрЃЉрЃљ рЃЊрЃљ `Thread #2` рЃерЃћрЃФрЃџрЃћрЃЉрЃА `client_vector`-рЃќрЃћ рЃЏрЃБрЃерЃљрЃЮрЃЉрЃўрЃА рЃњрЃљрЃњрЃарЃФрЃћрЃџрЃћрЃЉрЃљрЃА.

рЃћрЃА рЃДрЃЋрЃћрЃџрЃљрЃцрЃћрЃарЃў рЃарЃЮрЃЏ рЃерЃћрЃЋрЃФрЃџрЃЮ, рЃАрЃљрЃГрЃўрЃарЃЮрЃљ рЃљрЃЏ рЃЉрЃўрЃЉрЃџрЃўрЃЮрЃЌрЃћрЃЎрЃўрЃА `server.hpp` рЃцрЃљрЃўрЃџрЃерЃў рЃњрЃљрЃгрЃћрЃарЃљ:
```cpp
#include <mutex>
```

рЃљрЃ«рЃџрЃљ рЃБрЃЎрЃЋрЃћ рЃерЃћрЃЏрЃўрЃФрЃџрЃўрЃљ рЃерЃћрЃЋрЃЦрЃЏрЃюрЃљ `Mutex` рЃЮрЃЉрЃўрЃћрЃЦрЃбрЃў, рЃарЃЮрЃЏрЃћрЃџрЃўрЃф `client_vector`-рЃА рЃЊрЃљрЃўрЃфрЃљрЃЋрЃА. рЃЌрЃљрЃЋрЃЊрЃљрЃърЃўрЃарЃЋрЃћрЃџрЃљрЃЊ рЃљрЃАрЃћрЃЌ рЃарЃљрЃЏрЃћрЃА рЃњрЃљрЃЋрЃљрЃЎрЃћрЃЌрЃћрЃЉ `main()` рЃцрЃБрЃюрЃЦрЃфрЃўрЃљрЃерЃў, рЃарЃЮрЃЏрЃћрЃџрЃўрЃф, рЃарЃљ рЃЌрЃЦрЃЏрЃљ рЃБрЃюрЃЊрЃљ, `server.cpp` рЃцрЃљрЃўрЃџрЃерЃў рЃўрЃЦрЃюрЃћрЃЉрЃљ рЃЏрЃЮрЃЌрЃљрЃЋрЃАрЃћрЃЉрЃБрЃџрЃў:
```cpp
std::mutex client_vector_mutex;
```

рЃАрЃгрЃЮрЃарЃћрЃЊ рЃћрЃА рЃЊрЃљрЃўрЃфрЃљрЃЋрЃА `client_vector` рЃЋрЃћрЃЦрЃбрЃЮрЃарЃА. рЃљрЃ«рЃџрЃљ, рЃАрЃљрЃГрЃўрЃарЃЮрЃљ рЃАрЃћрЃарЃЋрЃћрЃарЃўрЃА рЃЉрЃўрЃарЃЌрЃЋрЃўрЃА рЃљрЃгрЃДрЃЮрЃЉрЃљ, рЃљрЃюрЃБ рЃўрЃА рЃюрЃљрЃгрЃўрЃџрЃў, рЃарЃЮрЃЏрЃћрЃџрЃўрЃф рЃБрЃерЃБрЃљрЃџрЃЮрЃЊ рЃЎрЃљрЃЋрЃерЃўрЃарЃўрЃА рЃЏрЃўрЃдрЃћрЃЉрЃљрЃќрЃћ рЃўрЃЦрЃюрЃћрЃЉрЃљ рЃърЃљрЃАрЃБрЃ«рЃўрЃАрЃЏрЃњрЃћрЃЉрЃћрЃџрЃў. рЃарЃљ рЃЌрЃЦрЃЏрЃљ рЃБрЃюрЃЊрЃљ, рЃАрЃћрЃарЃЋрЃћрЃарЃЏрЃљ рЃњрЃљрЃБрЃЕрЃћрЃарЃћрЃЉрЃџрЃљрЃЊ рЃБрЃюрЃЊрЃљ рЃўрЃЏрЃБрЃерЃљрЃЮрЃА, рЃљрЃАрЃћ рЃарЃЮрЃЏ рЃЏрЃЮрЃЏрЃўрЃгрЃћрЃЋрЃА рЃБрЃАрЃљрЃАрЃарЃБрЃџрЃЮрЃЊ рЃЏрЃЮрЃЏрЃБрЃерЃљрЃЋрЃћ рЃфрЃўрЃЎрЃџрЃўрЃА рЃерЃћрЃЦрЃЏрЃюрЃљ:
```cpp
while(true == true){
	if(client_vector.size() >= MAX_CLIENT){
	}
	else{
		std::thread new_thread(ReadFromClient, client_vector_mutex);
		new_thread.detach();
	}
}
```

рЃърЃўрЃарЃЋрЃћрЃџ рЃюрЃљрЃгрЃўрЃџрЃерЃў, рЃЏрЃўрЃЋрЃўрЃдрЃћрЃЉ рЃЎрЃџрЃўрЃћрЃюрЃбрЃА рЃЊрЃљ рЃБрЃЉрЃарЃљрЃџрЃЮрЃЊ рЃЋрЃћрЃбрЃДрЃЋрЃў, рЃарЃЮрЃЏ рЃАрЃћрЃарЃЋрЃћрЃарЃў рЃАрЃљрЃЋрЃАрЃћрЃљ. рЃЏрЃћрЃЮрЃарЃћ рЃерЃћрЃЏрЃЌрЃ«рЃЋрЃћрЃЋрЃљрЃерЃў, рЃерЃћрЃўрЃЦрЃЏрЃюрЃћрЃЉрЃљ рЃгрЃарЃћрЃЊрЃў, рЃарЃЮрЃЏрЃћрЃџрЃўрЃф рЃЏрЃЮрЃћрЃЏрЃАрЃљрЃ«рЃБрЃарЃћрЃЉрЃљ рЃЎрЃџрЃўрЃћрЃюрЃбрЃА. рЃарЃљ рЃЌрЃЦрЃЏрЃљ рЃБрЃюрЃЊрЃљ, рЃ»рЃћрЃарЃ»рЃћрЃарЃЮрЃЉрЃўрЃЌ рЃћрЃА рЃБрЃЉрЃарЃљрЃџрЃЮ рЃЏрЃЮрЃюрЃљрЃ«рЃљрЃќрЃўрЃљ, рЃАрЃўрЃюрЃљрЃЏрЃЊрЃЋрЃўрЃџрЃћрЃерЃў рЃЎрЃЮрЃЊрЃў рЃњрЃљрЃюрЃАрЃ«рЃЋрЃљрЃЋрЃћрЃЉрЃБрЃџрЃў рЃўрЃЦрЃюрЃћрЃЉрЃљ, рЃЏрЃљрЃњрЃарЃљрЃЏ рЃЊрЃљрЃљрЃ«рЃџрЃЮрЃћрЃЉрЃўрЃЌ рЃљрЃАрЃћрЃЌрЃў рЃарЃљрЃЏрЃўрЃА рЃњрЃљрЃЎрЃћрЃЌрЃћрЃЉрЃљрЃА рЃЋрЃљрЃърЃўрЃарЃћрЃЉ.

## HandleClient(); рЃцрЃБрЃюрЃЦрЃфрЃўрЃљ

рЃарЃљрЃф рЃерЃћрЃћрЃ«рЃћрЃЉрЃљ рЃљрЃЏ рЃцрЃБрЃюрЃЦрЃфрЃўрЃљрЃА, рЃўрЃА рЃЎрЃџрЃўрЃћрЃюрЃбрЃА `SSL/socket`-рЃўрЃА рЃњрЃљрЃЏрЃЮрЃДрЃћрЃюрЃћрЃЉрЃўрЃЌ рЃЏрЃЮрЃћрЃЏрЃАрЃљрЃ«рЃБрЃарЃћрЃЉрЃљ, рЃарЃљрЃф рЃњрЃБрЃџрЃўрЃАрЃ«рЃЏрЃЮрЃЉрЃА рЃўрЃЏрЃљрЃА, рЃарЃЮрЃЏ рЃАрЃЮрЃЎрЃћрЃбрЃў `SSL Tunnel`-рЃерЃў рЃњрЃљрЃўрЃЋрЃџрЃўрЃА рЃЊрЃљ рЃбрЃарЃљрЃцрЃўрЃЎрЃў рЃЊрЃљрЃерЃўрЃцрЃарЃБрЃџрЃў рЃўрЃЦрЃюрЃћрЃЉрЃљ.
```cpp
void ReadFromClient(std::mutex client_vector_mutex){
    std::lock_guard<std::mutex> lock(client_vector_mutex);
}
```

рЃарЃљ рЃЌрЃЦрЃЏрЃљ рЃБрЃюрЃЊрЃљ, рЃЌрЃљрЃЋрЃЊрЃљрЃърЃўрЃарЃЋрЃћрЃџрЃљрЃЊ рЃАрЃљрЃГрЃўрЃарЃЮрЃљ `Mutex`-рЃўрЃА рЃЕрЃљрЃЎрЃћрЃбрЃЋрЃљ, рЃарЃљрЃЌрЃљ `client_vector`-рЃќрЃћ рЃЏрЃБрЃерЃљрЃЮрЃЉрЃљ рЃерЃћрЃЋрЃФрЃџрЃЮ. рЃерЃћрЃЏрЃЊрЃћрЃњ, рЃАрЃљрЃГрЃўрЃарЃЮрЃљ `std::vector<Client> client_vector`-рЃўрЃА рЃърЃљрЃарЃљрЃЏрЃћрЃбрЃарЃћрЃЉрЃерЃў рЃЊрЃљрЃЏрЃљрЃбрЃћрЃЉрЃљ:
```cpp
void ReadFromClient(std::mutex client_vector_mutex, std::vector<Client> client_vector){
    std::lock_guard<std::mutex> lock(client_vector_mutex);
}
```

рЃњрЃљрЃарЃЎрЃЋрЃћрЃБрЃџрЃў рЃЏрЃЮрЃЊрЃўрЃцрЃўрЃЎрЃљрЃфрЃўрЃћрЃЉрЃўрЃА рЃерЃћрЃЊрЃћрЃњрЃљрЃЊ, рЃАрЃљрЃЉрЃЮрЃџрЃЮрЃЮ рЃ»рЃљрЃЏрЃерЃў, рЃљрЃАрЃћрЃЌрЃў `server.hpp` рЃцрЃљрЃўрЃџрЃў рЃЏрЃўрЃЋрЃўрЃдрЃћ:
```cpp
#pragma once

#include <mutex>
#include <algorithm>

#include <openssl/ssl.h>

/* Server Bind config */

#define SERVER_ADDRESS "0.0.0.0"
#define SERVER_PORT 8080

/* Server Logic config */
#define MAX_CLIENT 200

/* Communication config */
#define MESSAGE_SIZE 1024

class Client {
    public:
    char* username;

    char* ip_address;
    unsigned int port;

    int client_fd;
    SSL* ssl_fd;
};

void RemoveClient(std::vector<Client>& client_vector, int client_fd, std::mutex& client_vector_mutex) {
    std::lock_guard<std::mutex> lock(client_vector_mutex);

    client_vector.erase(
        std::remove_if(client_vector.begin(), client_vector.end(),
            [client_fd](const Client& client) {
                return client.client_fd == client_fd;
            }),
        client_vector.end());
}

void ReadFromClient(SSL* ssl_fd, int client_fd, sockaddr_in client_address, char* username, std::mutex& client_vector_mutex, std::vector<Client>& client_vector){
    {
        std::lock_guard<std::mutex> lock(client_vector_mutex);

        Client new_client;

        new_client.client_fd = client_fd;
        new_client.ssl_fd = ssl_fd;
        new_client.username = username;
        new_client.ip_address = inet_ntoa(client_address.sin_addr);
        new_client.port = ntohs(client_address.sin_port);

        client_vector.push_back(new_client);  
    }  

    while(true == true){
        char message_buffer[MESSAGE_SIZE];

        int received_bytes = SSL_read(ssl_fd, message_buffer, MESSAGE_SIZE - 1);

        if(received_bytes <= 0){
            continue;
        }
        else{
            message_buffer[received_bytes] = '\0';

            {
                std::lock_guard<std::mutex> lock(client_vector_mutex);

                for(const auto& client : client_vector){
                    SSL_write(client.ssl_fd, message_buffer, MESSAGE_SIZE);
                }
            }
        }
    }

    {
        std::lock_guard<std::mutex> lock(client_vector_mutex);
        RemoveClient(client_vector, client_fd, client_vector_mutex);
    }
}
```

рЃљрЃЦ рЃДрЃЋрЃћрЃџрЃљрЃќрЃћ рЃЏрЃюрЃўрЃерЃЋрЃюрЃћрЃџрЃЮрЃЋрЃљрЃюрЃў `scope`-рЃћрЃЉрЃўрЃА рЃљрЃюрЃљрЃџрЃўрЃќрЃўрЃљ.

> **­ЪЊ░ рЃАрЃљрЃўрЃюрЃбрЃћрЃарЃћрЃАрЃЮ рЃцрЃљрЃЦрЃбрЃў:**
> 
> рЃарЃЮрЃЊрЃћрЃАрЃљрЃф `std::lock_guard`-рЃўрЃЌ `Mutex` рЃўрЃ«рЃБрЃарЃћрЃЉрЃљ, рЃћрЃА рЃўрЃЏрЃљрЃА рЃюрЃўрЃерЃюрЃљрЃЋрЃА, рЃарЃЮрЃЏ рЃЏрЃ«рЃЮрЃџрЃЮрЃЊ рЃЎрЃЮрЃюрЃЎрЃарЃћрЃбрЃБрЃџ рЃгрЃарЃћрЃЊрЃА рЃерЃћрЃБрЃФрЃџрЃўрЃљ рЃАрЃљрЃЏрЃўрЃќрЃюрЃћрЃАрЃЌрЃљрЃю рЃЏрЃБрЃерЃљрЃЮрЃЉрЃљ. рЃАрЃљрЃЦрЃЏрЃћ рЃўрЃАрЃљрЃљ, рЃарЃЮрЃЏ рЃарЃЮрЃЊрЃћрЃАрЃљрЃф рЃћрЃА рЃ«рЃЊрЃћрЃЉрЃљ, рЃцрЃБрЃюрЃЦрЃфрЃўрЃљрЃерЃў рЃЏрЃљрЃА рЃфрЃљрЃџрЃЎрЃћ `scope` рЃБрЃюрЃЊрЃљ рЃњрЃљрЃЏрЃЮрЃћрЃДрЃЮрЃА, рЃарЃљрЃЌрЃљ `scope`-рЃўрЃА рЃЊрЃљрЃАрЃарЃБрЃџрЃћрЃЉрЃўрЃА рЃљрЃЊрЃњрЃўрЃџрЃќрЃћ рЃўрЃАрЃћрЃЋ, рЃљрЃЋрЃбрЃЮрЃЏрЃљрЃбрЃБрЃарЃљрЃЊ, рЃњрЃљрЃўрЃ«рЃАрЃюрЃљрЃА `Mutex`.

рЃарЃљ рЃЌрЃЦрЃЏрЃљ рЃБрЃюрЃЊрЃљ, рЃћрЃА рЃцрЃБрЃюрЃЦрЃфрЃўрЃљ рЃ»рЃћрЃа рЃЎрЃўрЃЊрЃћрЃЋ рЃЏрЃЮрЃюрЃљрЃ«рЃљрЃќрЃўрЃљ рЃЊрЃљ рЃЉрЃћрЃЋрЃа рЃфрЃЋрЃџрЃўрЃџрЃћрЃЉрЃљрЃА рЃњрЃљрЃюрЃўрЃфрЃЊрЃўрЃА рЃАрЃљрЃЏрЃЮрЃЏрЃљрЃЋрЃџрЃЮрЃЊ. рЃљрЃЏрЃЪрЃљрЃЏрЃљрЃЊ, рЃЊрЃарЃЮрЃљ рЃерЃћрЃЋрЃљрЃЏрЃЮрЃгрЃЏрЃЮ рЃАрЃгрЃЮрЃарЃљрЃЊ рЃЏрЃБрЃерЃљрЃЮрЃЉрЃА рЃЌрЃБ рЃљрЃарЃљ рЃАрЃћрЃарЃЋрЃћрЃа:

	g++ src/server.cpp -o server -pthread -lssl -lcrypto

рЃљрЃЏ рЃЉрЃарЃФрЃљрЃюрЃћрЃЉрЃўрЃЌ рЃерЃћрЃЋрЃФрЃџрЃћрЃЉ рЃЎрЃЮрЃЊрЃўрЃА рЃЎрЃЮрЃЏрЃърЃўрЃџрЃљрЃфрЃўрЃљрЃА. рЃАрЃљрЃюрЃљрЃЏ рЃЎрЃЮрЃЊрЃА рЃњрЃљрЃЊрЃљрЃЋрЃљрЃЎрЃЮрЃЏрЃърЃўрЃџрЃўрЃарЃћрЃЉ, `server.cpp` рЃцрЃљрЃўрЃџрЃўрЃф рЃњрЃљрЃАрЃљрЃАрЃгрЃЮрЃарЃћрЃЉрЃћрЃџрЃўрЃљ.

## рЃЎрЃЮрЃЊрЃўрЃА рЃЏрЃЌрЃљрЃЋрЃљрЃарЃў рЃюрЃљрЃгрЃўрЃџрЃў

рЃљрЃ«рЃџрЃљ, рЃЎрЃЮрЃЊрЃўрЃА рЃЏрЃЌрЃљрЃЋрЃљрЃа рЃюрЃљрЃгрЃўрЃџрЃќрЃћ рЃњрЃљрЃЊрЃљрЃЋрЃљрЃџ. рЃўрЃЏ рЃерЃћрЃЏрЃЌрЃ«рЃЋрЃћрЃЋрЃљрЃерЃў рЃЌрЃБ рЃАрЃћрЃарЃЋрЃћрЃарЃў рЃАрЃљрЃЋрЃАрЃћ рЃўрЃЦрЃюрЃћрЃЉрЃљ, рЃЎрЃџрЃўрЃћрЃюрЃбрЃА рЃЏрЃўрЃўрЃдрЃћрЃЉрЃА рЃЊрЃљ рЃБрЃърЃљрЃАрЃБрЃ«рЃћрЃЉрЃА, рЃарЃЮрЃЏ рЃљрЃЊрЃњрЃўрЃџрЃў рЃљрЃа рЃЊрЃљрЃарЃЕрЃљ рЃЏрЃўрЃАрЃЌрЃЋрЃўрЃА, рЃерЃћрЃЏрЃЊрЃћрЃњ рЃЎрЃў рЃЎрЃљрЃЋрЃерЃўрЃарЃА рЃЊрЃљрЃ«рЃБрЃарЃљрЃЋрЃА. рЃЌрЃБ рЃАрЃћрЃарЃЋрЃћрЃарЃў рЃАрЃљрЃЋрЃАрЃћ рЃљрЃа рЃўрЃЦрЃюрЃћрЃЉрЃљ, рЃЏрЃљрЃерЃўрЃю рЃЎрЃџрЃўрЃћрЃюрЃбрЃА рЃЏрЃўрЃўрЃдрЃћрЃЉрЃА рЃЊрЃљ рЃЏрЃўрЃАрЃЌрЃЋрЃўрЃА рЃфрЃљрЃџрЃЎрЃћ рЃгрЃарЃћрЃЊрЃА рЃњрЃљрЃЏрЃЮрЃДрЃЮрЃцрЃА. рЃљрЃЏ рЃДрЃЋрЃћрЃџрЃљрЃцрЃарЃўрЃА рЃњрЃљрЃЎрЃћрЃЌрЃћрЃЉрЃљ, рЃерЃћрЃЏрЃўрЃФрЃџрЃўрЃљ рЃўрЃЏ рЃЎрЃЮрЃЊрЃўрЃА рЃњрЃљрЃЏрЃЮрЃДрЃћрЃюрЃћрЃЉрЃўрЃЌ, рЃарЃЮрЃЏрЃћрЃџрЃўрЃф `main();` рЃцрЃБрЃюрЃЦрЃфрЃўрЃљрЃерЃў рЃЊрЃљрЃЋрЃљрЃЏрЃљрЃбрЃћ:
```cpp
while(true == true){
    if(client_vector.size() >= MAX_CLIENT){
        SSL* ssl_fd = SSL_new(ssl_context);

        if(!ssl_fd){
            SSL_free(ssl_fd);
            continue;
        }

        sockaddr_in client_address;
        socklen_t client_address_size;
        int client_fd = accept(server_socket, reinterpret_cast<sockaddr*>(&client_address), &client_address_size);

        if(client_fd < 0){
            SSL_free(ssl_fd);
            close(client_fd);
            continue;
        }

        char username_buffer[USERNAME_SIZE];
        int recevied_bytes = SSL_read(ssl_fd, username_buffer, USERNAME_SIZE - 1);

        if(recevied_bytes <= 0){
            SSL_free(ssl_fd);
            close(client_fd);
            continue;
        }

        username_buffer[recevied_bytes] = '\0';

        SSL_write(ssl_fd, CODE_SERVER_FULL, strlen(CODE_SERVER_FULL));

        SSL_free(ssl_fd);
        close(client_fd);
        continue;
    }
    else{
        SSL* ssl_fd = SSL_new(ssl_context);

        if(!ssl_fd){
            SSL_free(ssl_fd);
            continue;
        }

        sockaddr_in client_address;
        socklen_t client_address_size;
        int client_fd = accept(server_socket, reinterpret_cast<sockaddr*>(&client_address), &client_address_size);

        if(client_fd < 0){
            close(client_fd);
            continue;
        }

        SSL_set_fd(ssl_fd, client_fd);

        if(SSL_accept(ssl_fd) < 0 ){
            SSL_free(ssl_fd);
            close(client_fd);
            continue;
        }

        char username_buffer[USERNAME_SIZE];

        int received_bytes = SSL_read(ssl_fd, username_buffer, USERNAME_SIZE - 1);

        if(received_bytes <= 0){
            SSL_free(ssl_fd);
            close(client_fd);
            continue;
        }

        username_buffer[received_bytes] = '\0';

        std::thread new_thread(ReadFromClient, ssl_fd, client_fd, client_address, username_buffer, std::ref(client_vector_mutex), std::ref(client_vector));
        new_thread.detach();
    }
}
```
